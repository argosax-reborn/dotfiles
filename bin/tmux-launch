#!/bin/sh

# Created: 2015-04-30
#
# tmux-launch: run a program within a tmux + urxvt session, creating
# the session if necessary.
# dependencies: tmux, rxvt-unicode, wmctrl

TERM_NAME="urxvt-console"
TERM_EXIST=$(wmctrl -lx | cut -d' ' -f 4 | grep "^$TERM_NAME\..*$")
SESSION_NAME="0"

if [ -n "$1" ]; then
    PROG_NAME=$1; shift; PROG_ARGS=$@
    MATCHED_WINDOW=$(tmux list-windows -t $SESSION_NAME -F '#{window_id}:#{window_name}' 2>/dev/null | grep -m1 "^\(@[^:]*:\)\?$PROG_NAME\$" | cut -d':' -f 1)
fi

if [ -z "$TERM_EXIST" ]; then # TARGET TERMINAL DOES NOT EXIST
    unset TMUX # in case we are being run from within a tmux session
    if [ -n "$MATCHED_WINDOW" ]; then
        urxvt -name $TERM_NAME -e tmux new-session -A -D -s $SESSION_NAME \; select-window -t $SESSION_NAME:$MATCHED_WINDOW &
    else
        if tmux list-sessions -F '#{session_name}' 2>/dev/null | grep -q "^$SESSION_NAME$"; then # SESSION $SESSION_NAME EXISTS
            urxvt -name $TERM_NAME -e tmux attach-session -d -t $SESSION_NAME \; new-window "$PROG_NAME $PROG_ARGS" &
        elif [ -n "$PROG_NAME" ]; then
            urxvt -name $TERM_NAME -e tmux new-session -A -D -s $SESSION_NAME "$PROG_NAME $PROG_ARGS" &
        else
            urxvt -name $TERM_NAME -e tmux new-session -A -D -s $SESSION_NAME &
        fi
    fi
else # TARGET TERMINAL EXISTS
    if [ -n "$MATCHED_WINDOW" ]; then
        tmux select-window -t "$SESSION_NAME:$MATCHED_WINDOW" &
    elif [ -n "$PROG_NAME" ]; then
        tmux new-window -t "$SESSION_NAME:" "$PROG_NAME $PROG_ARGS" &
    fi
    wmctrl -xa "$TERM_NAME"
fi
